<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Service Based Launchpad Status & Configuration</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{
  --bg:#f5f7f9;--panel:#fff;--panel-alt:#f8fafc;--border:#d8dee3;--border-soft:#e5eaef;
  --text:#1f2d3d;--muted:#607180;--accent:#2474c7;--accent-h:#1d65af;
  --success:#1f8d47;--warn:#d8a10d;--danger:#d74a4a;--info:#516bff;--gray:#95a2ae;
  --focus:0 0 0 3px rgba(36,116,199,.38);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
  font-size:15px;
}
*{box-sizing:border-box;}
body{margin:0;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;line-height:1.42;}
h1,h2,h3{margin:0;font-weight:600;}
a{color:var(--accent);text-decoration:none;}a:hover{text-decoration:underline;}
.wrapper{max-width:1500px;margin:0 auto;padding:1.3rem 1.25rem 3rem;display:grid;gap:1.4rem;}
.grid{display:grid;gap:1.4rem;grid-template-columns:1fr 420px;}
@media (max-width:1200px){.grid{grid-template-columns:1fr;}}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:20px;padding:1.25rem 1.4rem 1.5rem;box-shadow:0 6px 18px -10px rgba(0,0,0,.08);display:flex;flex-direction:column;gap:1rem;position:relative;}
.panel-header{display:flex;align-items:center;gap:.8rem;flex-wrap:wrap;margin:0;}
.badge{display:inline-flex;align-items:center;justify-content:center;padding:4px 10px;border-radius:999px;font-size:.55rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:#fff;background:#34495e;}
.sub-head{font-size:.65rem;color:var(--muted);letter-spacing:.05em;text-transform:uppercase;font-weight:600;margin:0 0 .2rem;}
.status-cards{display:grid;gap:.9rem;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));}
.status-card{background:var(--panel-alt);border:1px solid var(--border-soft);border-radius:14px;padding:.75rem .85rem;display:flex;flex-direction:column;gap:.45rem;position:relative;min-height:86px;}
.status-card h3{font-size:.72rem;margin:0;letter-spacing:.07em;text-transform:uppercase;color:var(--muted);font-weight:700;}
.metric{font-size:1.55rem;font-weight:600;line-height:1;}
.delta{font-size:.58rem;font-weight:600;letter-spacing:.05em;}
.delta.up{color:var(--success);} .delta.down{color:var(--danger);} .delta.flat{color:var(--muted);}
.legend-dots{display:flex;flex-wrap:wrap;gap:.5rem;font-size:.58rem;}
.legend-dots span{display:inline-flex;align-items:center;gap:.35rem;}
.dot{width:10px;height:10px;border-radius:4px;display:inline-block;}
.dot.enabled{background:var(--success);} .dot.disabled{background:var(--gray);}
.dot.partial{background:var(--warn);} .dot.error{background:var(--danger);} .dot.deploy{background:var(--info);}
.table-wrap{border:1px solid var(--border);border-radius:16px;overflow:auto;background:#fff;max-height:420px;}
.status-table{width:100%;border-collapse:collapse;min-width:780px;font-size:.68rem;}
.status-table th,.status-table td{padding:9px 11px;border-bottom:1px solid var(--border-soft);text-align:left;vertical-align:top;}
.status-table th{background:#f1f4f6;font-size:.55rem;letter-spacing:.06em;text-transform:uppercase;font-weight:600;position:sticky;top:0;z-index:1;}
.status-pill{display:inline-flex;align-items:center;gap:.3rem;padding:2px 7px;font-size:.53rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;border-radius:999px;}
.status-pill.enabled{background:var(--success);color:#fff;}
.status-pill.disabled{background:var(--gray);color:#fff;}
.status-pill.partial{background:var(--warn);color:#222;}
.status-pill.error{background:var(--danger);color:#fff;}
.status-pill.deploy{background:var(--info);color:#fff;}
.inline-note{font-size:.6rem;color:var(--muted);}
.actions{display:flex;gap:.4rem;flex-wrap:wrap;}
.icon-btn{background:#e6edf2;border:1px solid var(--border);width:34px;height:34px;border-radius:9px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;transition:.16s;}
.icon-btn:hover{background:#dce5ea;}
.icon-btn:focus-visible{outline:none;box-shadow:var(--focus);}
.icon-btn.edit{background:var(--accent);border-color:var(--accent);color:#fff;}
.icon-btn.delete{background:var(--danger);border-color:var(--danger);color:#fff;}
.icon-btn.view{background:#516bff;border-color:#516bff;color:#fff;}
.config-grid{display:grid;gap:1rem;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));}
.config-tile{background:var(--panel-alt);border:1px solid var(--border-soft);border-radius:16px;padding:.85rem .9rem;display:flex;flex-direction:column;gap:.4rem;min-height:120px;position:relative;}
.config-tile h3{margin:0;font-size:.72rem;letter-spacing:.06em;text-transform:uppercase;color:var(--muted);font-weight:700;}
.cfg-meta{font-size:.55rem;color:var(--muted);line-height:1.3;display:flex;flex-direction:column;gap:2px;}
.toggle-switch{position:relative;display:inline-block;width:48px;height:26px;}
.toggle-switch input{opacity:0;width:0;height:0;}
.toggle-switch span{position:absolute;inset:0;background:#b3bcc5;border-radius:28px;cursor:pointer;transition:.25s;}
.toggle-switch span:before{content:"";position:absolute;height:20px;width:20px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.25s;box-shadow:0 2px 4px rgba(0,0,0,.25);}
.toggle-switch input:checked + span{background:var(--success);}
.toggle-switch input:checked + span:before{transform:translateX(22px);}
.tile-actions{margin-top:auto;display:flex;gap:.4rem;flex-wrap:wrap;}
.sep{height:1px;background:linear-gradient(90deg,#dfe4e9,#eef2f5);margin:.6rem 0;}
.badge-mode{display:inline-flex;align-items:center;justify-content:center;padding:2px 8px;font-size:.52rem;font-weight:700;letter-spacing:.05em;border-radius:7px;text-transform:uppercase;background:#34495e;color:#fff;}
.badge-env{background:#516bff;}
.filter-row{display:flex;flex-wrap:wrap;gap:.6rem;align-items:center;font-size:.58rem;}
.filter-row select,.filter-row input{padding:.45rem .6rem;font-size:.65rem;border:1px solid var(--border);border-radius:8px;background:#fff;}
.filter-row select:focus,.filter-row input:focus{outline:none;box-shadow:var(--focus);border-color:var(--accent);}
.small-btn{background:#e6edf2;border:1px solid var(--border);padding:.42rem .75rem;font-size:.55rem;font-weight:600;text-transform:uppercase;border-radius:8px;cursor:pointer;letter-spacing:.05em;}
.small-btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;}
.small-btn.danger{background:var(--danger);border-color:var(--danger);color:#fff;}
.small-btn:hover{filter:brightness(.95);}
.small-btn:focus-visible{outline:none;box-shadow:var(--focus);}
.flash{font-size:.55rem;font-weight:600;color:var(--success);opacity:0;transition:.3s;}
.flash.visible{opacity:1;}
.config-dialog{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;padding:6vh 1rem 4rem;background:rgba(25,38,52,.55);z-index:2000;}
.config-dialog[aria-hidden="false"]{display:flex;}
.cfg-panel{background:#fff;border:1px solid var(--border);border-radius:20px;max-width:640px;width:100%;padding:1.2rem 1.35rem 1.35rem;display:flex;flex-direction:column;gap:1rem;box-shadow:0 18px 36px -12px rgba(0,0,0,.35);position:relative;}
.cfg-panel header{display:flex;align-items:center;justify-content:space-between;margin:0;}
.cfg-panel h3{font-size:.95rem;margin:0;}
.close-btn{background:#eef2f5;border:1px solid var(--border);width:34px;height:34px;border-radius:9px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.close-btn:hover{background:#e1e8ec;}
.close-btn:focus-visible{outline:none;box-shadow:var(--focus);}
.form-grid{display:grid;gap:.9rem;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));}
.form-group{display:flex;flex-direction:column;gap:4px;}
.form-group label{font-size:.55rem;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:var(--muted);}
.form-group input,.form-group select,.form-group textarea{padding:.55rem .6rem;font-size:.68rem;border:1px solid var(--border);border-radius:8px;font-family:inherit;background:#fff;}
.form-group textarea{resize:vertical;min-height:90px;}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;box-shadow:var(--focus);border-color:var(--accent);}
.dialog-actions{display:flex;justify-content:flex-end;gap:.6rem;flex-wrap:wrap;}
.footer-note{font-size:.55rem;color:var(--muted);text-align:center;margin-top:1.1rem;}
.visually-hidden{position:absolute!important;width:1px;height:1px;clip:rect(1px,1px,1px,1px);clip-path:inset(50%);overflow:hidden;white-space:nowrap;}
@media (max-width:740px){
  .status-table{min-width:640px;}
  .config-grid{grid-template-columns:repeat(auto-fill,minmax(160px,1fr));}
}
</style>
</head>
<body>
<div class="wrapper">
  <header style="text-align:center;display:flex;flex-direction:column;gap:.5rem;">
    <h1 style="font-size:1.75rem;">Service Based Launchpad Status</h1>
    <p style="margin:0;font-size:.85rem;color:var(--muted);">Aggregated enablement, deployment and configuration view derived from tc_admin.png patterns.</p>
  </header>

  <div class="grid">
    <!-- LEFT: STATUS & TABLE -->
    <section class="panel" aria-labelledby="status-heading">
      <div class="panel-header">
        <span class="badge">Status</span>
        <h2 id="status-heading" style="font-size:1.05rem;">Launchpad Overview</h2>
        <span id="lp-flash" class="flash" aria-live="polite"></span>
      </div>

      <div class="status-cards" id="status-cards">
        <!-- filled via JS -->
      </div>

      <div class="filter-row" style="margin-top:.2rem;">
        <label style="font-weight:600;">Filter Mode
          <select id="mode-filter">
            <option value="all">All</option>
            <option>Fully</option>
            <option>Partially</option>
            <option>Restricted</option>
            <option>Unmanaged</option>
          </select>
        </label>
        <label style="font-weight:600;">State
          <select id="state-filter">
            <option value="all">All</option>
            <option value="enabled">Enabled</option>
            <option value="partial">Partial</option>
            <option value="disabled">Disabled</option>
            <option value="error">Error</option>
          </select>
        </label>
        <input id="search-filter" type="text" placeholder="Search service…" aria-label="Search services">
        <button id="reset-filters" class="small-btn" disabled>Reset</button>
        <button id="refresh-btn" class="small-btn primary">Refresh</button>
        <button id="bulk-enable" class="small-btn primary">Enable All</button>
        <button id="bulk-disable" class="small-btn danger">Disable All</button>
      </div>

      <div class="legend-dots">
        <span><span class="dot enabled"></span>Enabled</span>
        <span><span class="dot partial"></span>Partial</span>
        <span><span class="dot disabled"></span>Disabled</span>
        <span><span class="dot error"></span>Error</span>
        <span><span class="dot deploy"></span>Deployed</span>
      </div>

      <div class="table-wrap" aria-label="Launchpad status table">
        <table class="status-table" id="lp-table">
          <thead>
            <tr>
              <th style="width:180px;">Service</th>
              <th style="width:70px;">Mode</th>
              <th style="width:85px;">State</th>
              <th style="width:80px;">Deploy</th>
              <th style="width:100px;">Last Change</th>
              <th>Description</th>
              <th style="width:130px;">Actions</th>
            </tr>
          </thead>
          <tbody id="lp-tbody">
            <!-- rows -->
          </tbody>
        </table>
      </div>
      <p class="inline-note" id="lp-empty" hidden>No services match filters.</p>
    </section>

    <!-- RIGHT: CONFIG TILE SET -->
    <section class="panel" aria-labelledby="config-heading">
      <div class="panel-header">
        <span class="badge">Config</span>
        <h2 id="config-heading" style="font-size:1.05rem;">Service Configuration</h2>
      </div>
      <p class="inline-note" style="margin:-.4rem 0 .2rem;">Tiles surface per‑service launchpad configuration facets (environment, feature flags, synchronization).</p>

      <div class="config-grid" id="config-tiles">
        <!-- tiles injected -->
      </div>
      <div class="sep"></div>
      <button id="add-config" class="small-btn primary">Add Config</button>
      <button id="sync-all" class="small-btn">Sync All</button>
      <span id="cfg-flash" class="flash" aria-live="polite"></span>
    </section>
  </div>

  <footer class="footer-note">Client-side demo only. Data resets on reload.</footer>
</div>

<!-- CONFIG DIALOG -->
<div id="cfg-dialog" class="config-dialog" aria-hidden="true">
  <div class="cfg-panel" role="dialog" aria-modal="true" aria-labelledby="cfg-title" aria-describedby="cfg-desc" tabindex="-1">
    <header>
      <h3 id="cfg-title">Edit Configuration</h3>
      <button class="close-btn" id="cfg-close" aria-label="Close dialog">
        <svg width="16" height="16" viewBox="0 0 24 24"><path d="M5 5l14 14M19 5 5 19" fill="none" stroke="#23313f" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
    </header>
    <p id="cfg-desc" class="visually-hidden">Form to edit service configuration values.</p>
    <form id="cfg-form" novalidate>
      <input type="hidden" id="cfg-id">
      <div class="form-grid">
        <div class="form-group">
          <label for="cfg-name">Service</label>
            <input id="cfg-name" readonly>
        </div>
        <div class="form-group">
          <label for="cfg-env">Environment</label>
          <select id="cfg-env">
            <option>Prod</option><option>Stage</option><option>Dev</option>
          </select>
        </div>
        <div class="form-group">
          <label for="cfg-refresh">Refresh Interval (min)</label>
          <input id="cfg-refresh" type="number" min="1" value="15">
        </div>
        <div class="form-group">
          <label for="cfg-flags">Feature Flags (comma)</label>
          <input id="cfg-flags" placeholder="alpha, canary">
        </div>
        <div class="form-group">
          <label for="cfg-notes">Notes</label>
          <textarea id="cfg-notes" maxlength="400" placeholder="Optional implementation notes"></textarea>
        </div>
        <div class="form-group">
          <label>Enable</label>
          <label class="toggle-switch">
            <input id="cfg-enabled" type="checkbox">
            <span></span>
          </label>
        </div>
      </div>
      <div class="dialog-actions">
        <button type="button" class="small-btn" id="cfg-cancel">Cancel</button>
        <button type="submit" class="small-btn primary" id="cfg-save">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
(function(){
  /* Data */
  const services = [
    {id:1,name:'Identity Core',mode:'Fully',state:'enabled',deploy:true,desc:'Central auth & SSO integration.',changed:randMinutes(),env:'Prod',flags:['core'],refresh:30,notes:'Stable'},
    {id:2,name:'Notification Service',mode:'Partially',state:'partial',deploy:false,desc:'Email & SMS dispatch',changed:randMinutes(),env:'Stage',flags:['alpha'],refresh:15,notes:''},
    {id:3,name:'Report Generator',mode:'Partially',state:'enabled',deploy:true,desc:'Scheduled reports engine',changed:randMinutes(),env:'Prod',flags:['beta'],refresh:20,notes:'Check timezone offsets'},
    {id:4,name:'Cache Service',mode:'Partially',state:'disabled',deploy:false,desc:'Low-latency caching tier',changed:randMinutes(),env:'Dev',flags:[],refresh:10,notes:''},
    {id:5,name:'Access Registry',mode:'Restricted',state:'enabled',deploy:true,desc:'Access grants repository',changed:randMinutes(),env:'Prod',flags:['critical'],refresh:45,notes:''},
    {id:6,name:'Custom Analytics',mode:'Unmanaged',state:'error',deploy:false,desc:'Analytics experiment set',changed:randMinutes(),env:'Dev',flags:['exp'],refresh:15,notes:'Investigate ingestion delay'},
    {id:7,name:'Webhook Relay',mode:'Unmanaged',state:'disabled',deploy:false,desc:'External webhook relay',changed:randMinutes(),env:'Stage',flags:[],refresh:30,notes:''}
  ];
  function randMinutes(){return Date.now()- (Math.random()*360)*60000;}

  /* Elements */
  const tbody = document.getElementById('lp-tbody');
  const empty = document.getElementById('lp-empty');
  const statusCards = document.getElementById('status-cards');
  const searchInput = document.getElementById('search-filter');
  const modeFilter = document.getElementById('mode-filter');
  const stateFilter = document.getElementById('state-filter');
  const resetFilters = document.getElementById('reset-filters');
  const refreshBtn = document.getElementById('refresh-btn');
  const bulkEnable = document.getElementById('bulk-enable');
  const bulkDisable = document.getElementById('bulk-disable');
  const flash = document.getElementById('lp-flash');

  const tileContainer = document.getElementById('config-tiles');
  const addCfg = document.getElementById('add-config');
  const syncAll = document.getElementById('sync-all');
  const cfgFlash = document.getElementById('cfg-flash');

  const dialog = document.getElementById('cfg-dialog');
  const cfgForm = document.getElementById('cfg-form');
  const cfgId = document.getElementById('cfg-id');
  const cfgName = document.getElementById('cfg-name');
  const cfgEnv = document.getElementById('cfg-env');
  const cfgRefresh = document.getElementById('cfg-refresh');
  const cfgFlags = document.getElementById('cfg-flags');
  const cfgNotes = document.getElementById('cfg-notes');
  const cfgEnabled = document.getElementById('cfg-enabled');
  const cfgClose = document.getElementById('cfg-close');
  const cfgCancel = document.getElementById('cfg-cancel');
  let lastFocus=null;

  /* Rendering */
  function pill(state){
    return `<span class="status-pill ${state}">${state}</span>`;
  }
  function deployMark(d){return d ? '<span class="status-pill deploy">yes</span>' : '<span class="status-pill disabled">no</span>'; }
  function ago(ts){
    const diff = Date.now()-ts;
    const m = Math.floor(diff/60000);
    if(m<60) return m+'m ago';
    const h = Math.floor(m/60);
    if(h<24) return h+'h ago';
    return Math.floor(h/24)+'d ago';
  }
  function applyFilters(){
    const term = searchInput.value.trim().toLowerCase();
    const mf = modeFilter.value;
    const sf = stateFilter.value;
    let out='';
    let visible=0;
    services.forEach(s=>{
      if((mf!=='all' && s.mode!==mf) || (sf!=='all' && s.state!==sf)) return;
      if(term && !s.name.toLowerCase().includes(term) && !s.desc.toLowerCase().includes(term)) return;
      visible++;
      out+=`
      <tr data-id="${s.id}">
        <td>${s.name}</td>
        <td><span class="badge-mode">${s.mode}</span></td>
        <td>${pill(s.state)}</td>
        <td>${deployMark(s.deploy)}</td>
        <td title="${new Date(s.changed).toLocaleString()}">${ago(s.changed)}</td>
        <td>${s.desc}</td>
        <td>
          <div class="actions">
            <button class="icon-btn view" data-act="view" aria-label="View ${s.name} config">V</button>
            <button class="icon-btn edit" data-act="toggle" aria-label="Toggle ${s.name}">${s.state==='enabled'?'⏻':'⭘'}</button>
            <button class="icon-btn delete" data-act="error" aria-label="Mark ${s.name} error">!</button>
          </div>
        </td>
      </tr>`;
    });
    tbody.innerHTML=out;
    empty.hidden = visible>0;
    updateReset();
    renderCards();
  }
  function renderCards(){
    const total = services.length;
    const enabled = services.filter(s=>s.state==='enabled').length;
    const partial = services.filter(s=>s.state==='partial').length;
    const disabled = services.filter(s=>s.state==='disabled').length;
    const error = services.filter(s=>s.state==='error').length;
    const deployed = services.filter(s=>s.deploy).length;
    statusCards.innerHTML = cardHTML('Enabled',enabled,total,'success','up')
      + cardHTML('Partial',partial,total,'warn', partial? 'flat':'flat')
      + cardHTML('Disabled',disabled,total,'gray','flat')
      + cardHTML('Error',error,total,error?'danger':'gray', error?'up':'flat')
      + cardHTML('Deployed',deployed,total,'info','flat');
  }
  function pct(v,t){return t?((v/t)*100).toFixed(0)+'%':'0%';}
  function cardHTML(label,val,total,type,trend){
    const colorMap={success:'var(--success)',warn:'var(--warn)',danger:'var(--danger)',gray:'var(--gray)',info:'var(--info)'};
    return `<div class="status-card" aria-label="${label} metric">
      <h3>${label}</h3>
      <div class="metric" style="color:${colorMap[type]};">${val}</div>
      <div class="delta ${trend}">${pct(val,total)}</div>
    </div>`;
  }

  function renderTiles(){
    tileContainer.innerHTML = services.map(s=>`
      <div class="config-tile" data-id="${s.id}">
        <h3>${s.name}</h3>
        <div class="cfg-meta">
          <span><strong>Env:</strong> <span class="badge-mode badge-env">${s.env}</span></span>
          <span><strong>Flags:</strong> ${s.flags.length?s.flags.join(', '):'—'}</span>
          <span><strong>Refresh:</strong> ${s.refresh}m</span>
          <span><strong>State:</strong> ${s.state}</span>
        </div>
        <div style="margin-top:.25rem;">
          <label class="toggle-switch" title="Enable/Disable">
            <input type="checkbox" data-act="tile-toggle" ${s.state==='enabled'?'checked':''}>
            <span></span>
          </label>
        </div>
        <div class="tile-actions">
          <button class="small-btn" data-act="edit">Edit</button>
          <button class="small-btn" data-act="sync">Sync</button>
        </div>
      </div>
    `).join('');
  }

  /* Events */
  [searchInput,modeFilter,stateFilter].forEach(el=>el.addEventListener('input', applyFilters));
  refreshBtn.addEventListener('click',()=>{
    services.forEach(s=> s.changed = Date.now() - Math.random()*600000);
    flashMsg('Refreshed');
    applyFilters();
  });
  bulkEnable.addEventListener('click',()=>{
    services.forEach(s=> s.state='enabled');
    flashMsg('All enabled'); applyFilters(); renderTiles();
  });
  bulkDisable.addEventListener('click',()=>{
    services.forEach(s=> s.state='disabled');
    flashMsg('All disabled'); applyFilters(); renderTiles();
  });
  resetFilters.addEventListener('click',()=>{
    searchInput.value='';modeFilter.value='all';stateFilter.value='all';
    applyFilters();
  });

  tbody.addEventListener('click',e=>{
    const btn=e.target.closest('[data-act]'); if(!btn) return;
    const id=+btn.closest('tr').dataset.id;
    const svc=services.find(s=>s.id===id);
    if(!svc) return;
    const act=btn.dataset.act;
    if(act==='toggle'){
      svc.state = (svc.state==='enabled') ? 'disabled':'enabled';
      svc.changed = Date.now();
      applyFilters(); renderTiles();
    } else if(act==='error'){
      svc.state='error'; svc.changed=Date.now();
      applyFilters(); renderTiles();
    } else if(act==='view'){
      openDialog(svc);
    }
  });

  tileContainer.addEventListener('click',e=>{
    const btn=e.target.closest('[data-act]');
    if(!btn) return;
    const tile=btn.closest('.config-tile');
    const svc=services.find(s=>s.id==tile.dataset.id);
    if(!svc) return;
    const act=btn.dataset.act;
    if(act==='edit'){openDialog(svc);}
    else if(act==='sync'){svc.changed=Date.now(); cfgFlashMsg('Synced '+svc.name);}
  });
  tileContainer.addEventListener('change',e=>{
    const input=e.target;
    if(input.dataset.act==='tile-toggle'){
      const svc=services.find(s=>s.id==input.closest('.config-tile').dataset.id);
      if(svc){svc.state=input.checked?'enabled':'disabled'; svc.changed=Date.now(); applyFilters();}
    }
  });

  addCfg.addEventListener('click',()=>{
    const newId = Math.max(...services.map(s=>s.id))+1;
    services.push({id:newId,name:'New Service '+newId,mode:'Unmanaged',state:'disabled',deploy:false,desc:'New placeholder service',changed:Date.now(),env:'Dev',flags:[],refresh:15,notes:''});
    renderTiles(); applyFilters();
    cfgFlashMsg('Added service');
  });

  syncAll.addEventListener('click',()=>{
    services.forEach(s=> s.changed=Date.now());
    cfgFlashMsg('Synced all');
    applyFilters();
  });

  function updateReset(){
    const active = searchInput.value || modeFilter.value!=='all' || stateFilter.value!=='all';
    resetFilters.disabled = !active;
  }

  function flashMsg(msg){
    flash.textContent=msg;
    flash.classList.add('visible');
    setTimeout(()=>flash.classList.remove('visible'),1400);
  }
  function cfgFlashMsg(msg){
    cfgFlash.textContent=msg;
    cfgFlash.classList.add('visible');
    setTimeout(()=>cfgFlash.classList.remove('visible'),1400);
  }

  /* Dialog */
  function openDialog(svc){
    lastFocus=document.activeElement;
    cfgId.value=svc.id;
    cfgName.value=svc.name;
    cfgEnv.value=svc.env;
    cfgRefresh.value=svc.refresh;
    cfgFlags.value=svc.flags.join(', ');
    cfgNotes.value=svc.notes;
    cfgEnabled.checked = svc.state==='enabled';
    dialog.setAttribute('aria-hidden','false');
    setTimeout(()=>dialog.querySelector('.cfg-panel').focus(),30);
  }
  function closeDialog(){
    dialog.setAttribute('aria-hidden','true');
    lastFocus && lastFocus.focus();
  }
  cfgClose.addEventListener('click',closeDialog);
  cfgCancel.addEventListener('click',closeDialog);
  dialog.addEventListener('click',e=>{if(e.target===dialog) closeDialog();});
  dialog.addEventListener('keydown',e=>{
    if(e.key==='Escape'){e.preventDefault();closeDialog();}
    if(e.key==='Tab'){
      const f=[...dialog.querySelectorAll('button,[href],input,select,textarea')].filter(el=>!el.disabled && el.offsetParent);
      if(!f.length)return;
      const first=f[0],last=f[f.length-1];
      if(e.shiftKey && document.activeElement===first){e.preventDefault();last.focus();}
      else if(!e.shiftKey && document.activeElement===last){e.preventDefault();first.focus();}
    }
  });

  cfgForm.addEventListener('submit',e=>{
    e.preventDefault();
    const svc=services.find(s=>s.id==cfgId.value);
    if(svc){
      svc.env=cfgEnv.value;
      svc.refresh=+cfgRefresh.value;
      svc.flags = cfgFlags.value.split(',').map(s=>s.trim()).filter(Boolean);
      svc.notes = cfgNotes.value.trim();
      svc.state = cfgEnabled.checked ? (svc.state==='error'?'enabled':'enabled') : 'disabled';
      svc.changed=Date.now();
    }
    closeDialog();
    renderTiles(); applyFilters();
    cfgFlashMsg('Saved '+svc.name);
  });

  /* Init */
  renderTiles();
  applyFilters();
})();
</script>
</body>
</html>