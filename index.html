<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Service Management UI (Optimized)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:#f4f7f9;margin:0;padding:2rem;color:#333;}
.container{max-width:900px;margin:0 auto;background:#fff;padding:2rem;border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,.1);}
h1{margin:0;text-align:center;color:#2c3e50;}
.selectors-stack{display:flex;flex-wrap:wrap;gap:1rem;align-items:center;}
.mode-select-wrapper,.role-select-wrapper{display:flex;align-items:center;gap:.5rem;font-size:.9rem;}
.mode-select-wrapper select,.role-select-wrapper select{padding:.4rem .6rem;}
.mode-badge,.role-badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:.7rem;text-transform:uppercase;background:#ecf0f1;color:#555;margin-left:8px;}
.mode-Restricted{background:#e74c3c;color:#fff;}
.mode-Fully{background:#2ecc71;color:#fff;}
.mode-Partially{background:#f1c40f;color:#333;}
.mode-Unmanaged{background:#8e44ad;color:#fff;}
.role-Admin{background:#34495e;color:#fff;}
.role-Read{background:#7f8c8d;color:#fff;}
.button{padding:.6rem 1.2rem;border:none;border-radius:5px;font-size:.9rem;cursor:pointer;transition:.2s;}
.button-primary{background:#3498db;color:#fff;}
.button-primary:hover:not(:disabled){background:#2980b9;}
.button-primary:disabled{background:#aeb6bf;cursor:not-allowed;}
#add-service-btn{margin:10px 0;}
.table-container{overflow-y:auto;max-height:420px;border:1px solid #ddd;border-radius:8px;}
.crud-table{width:100%;border-collapse:collapse;}
.crud-table th,.crud-table td{padding:12px 15px;border-bottom:1px solid #ddd;text-align:left;vertical-align:top;}
.crud-table th{background:#ecf0f1;font-weight:600;text-transform:uppercase;font-size:.75rem;letter-spacing:.05em;position:sticky;top:0;z-index:5;}
.crud-table tbody tr:hover{background:#f8f9fa;}
#enable-all-toggle{margin-left:6px;cursor:pointer;transform:translateY(1px);}
#enable-all-toggle:disabled{cursor:not-allowed;opacity:.5;}
.service-details{display:flex;flex-direction:column;gap:4px;}
.service-details .name{font-weight:600;}
.service-details .description{font-size:.85rem;color:#666;}
.service-details .last-updated{font-size:.65rem;color:#888;text-transform:uppercase;letter-spacing:.05em;}
.action-buttons{display:flex;gap:8px;}
.action-button{background:none;border:none;font-size:1.05rem;cursor:pointer;opacity:.85;transition:.2s;}
.action-button:hover{opacity:1;}
.action-button.edit{color:#2980b9;}
.action-button.delete{color:#e74c3c;}
.status-button-like{padding:.45rem .9rem;border-radius:18px;font-weight:600;font-size:.7rem;text-transform:uppercase;color:#fff;border:none;cursor:pointer;letter-spacing:.05em;}
.status-button-like.enabled{background:#2ecc71;}
.status-button-like.disabled{background:#bdc3c7;}
.form-actions{display:flex;justify-content:space-between;align-items:center;margin-top:1.25rem;}
.confirmation-message{color:#27ae60;font-weight:600;opacity:0;transition:.3s;font-size:.85rem;}
.confirmation-message.visible{opacity:1;}
.modal{display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.5);justify-content:center;align-items:center;padding:1rem;}
.modal-content{background:#fff;padding:1.75rem 1.75rem 2rem;border-radius:10px;width:100%;max-width:520px;position:relative;}
.modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #ecf0f1;padding-bottom:.75rem;margin-bottom:1.25rem;}
.modal-header h2{margin:0;font-size:1.1rem;font-weight:600;}
.modal-close{color:#999;font-size:26px;font-weight:bold;cursor:pointer;line-height:1;}
.modal-close:hover{color:#666;}
.form-group{margin-bottom:1.1rem;}
.form-group label{display:block;margin-bottom:.4rem;font-weight:600;color:#555;font-size:.8rem;letter-spacing:.04em;text-transform:uppercase;}
.form-group textarea{width:100%;padding:.65rem .75rem;border:1px solid #d0d7de;border-radius:6px;font-size:.85rem;font-family:inherit;resize:vertical;box-sizing:border-box;}
.form-group textarea[readonly]{background:#f5f6f7;}
.toggle-switch{position:relative;display:inline-block;width:54px;height:28px;}
.toggle-switch input{opacity:0;width:0;height:0;}
.toggle-slider{position:absolute;inset:0;background:#ccc;border-radius:28px;cursor:pointer;transition:.3s;}
.toggle-slider:before{content:"";position:absolute;height:22px;width:22px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s;box-shadow:0 1px 3px rgba(0,0,0,.3);}
input:checked + .toggle-slider{background:#2ecc71;}
input:checked + .toggle-slider:before{transform:translateX(26px);}
th.hidden,td.hidden{display:none!important;}
.read-only-overlay{position:absolute;inset:0;background:rgba(255,255,255,.55);display:none;border-radius:10px;pointer-events:none;}
.modal.read-only .read-only-overlay{display:block;}
.deploy-wrapper{display:flex;flex-direction:column;align-items:flex-start;}
.last-run{margin-top:4px;font-size:.65rem;color:#666;line-height:1.2;}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div style="display:flex;align-items:center;gap:.5rem;">
      <h1>Service Management
        <span id="mode-badge" class="mode-badge mode-Fully">Fully Managed</span>
        <span id="role-badge" class="role-badge role-Admin">Admin</span>
      </h1>
    </div>
    <div class="selectors-stack" id="selectors-area">
      <div class="mode-select-wrapper">
        <label for="mode-select">Mode:</label>
        <select id="mode-select">
          <option value="Fully Managed" selected>Fully Managed</option>
          <option value="Partially Managed">Partially Managed</option>
          <option value="Restricted">Restricted</option>
          <option value="Unmanaged">Unmanaged</option>
        </select>
      </div>
      <div class="role-select-wrapper">
        <label for="role-select">Role:</label>
        <select id="role-select">
          <option value="Admin" selected>Admin</option>
          <option value="Read Only">Read Only</option>
        </select>
      </div>
      <button class="button button-primary" id="add-service-btn">Enable SBL Service</button>
    </div>
  </div>

  <div class="table-container" id="table-wrapper" style="display:none;">
    <table class="crud-table">
      <thead>
        <tr>
          <th>Service</th>
          <th>Enabled <input type="checkbox" id="enable-all-toggle" title="Enable/Disable all services"></th>
          <th id="deploy-col-header">Deployed</th>
          <th id="actions-col-header">Actions</th>
        </tr>
      </thead>
      <tbody id="service-list"></tbody>
    </table>
  </div>

  <div class="form-actions" id="actions-bar" style="display:none;">
    <span id="confirmation-msg" class="confirmation-message"></span>
    <button class="button button-primary" id="save-changes-btn" disabled>Save Changes</button>
  </div>
</div>

<div id="service-modal" class="modal">
  <div class="modal-content" id="modal-inner">
    <div class="read-only-overlay"></div>
    <div class="modal-header">
      <h2 id="modal-title">Edit Service</h2>
      <span class="modal-close" title="Close">&times;</span>
    </div>
    <form id="service-form" autocomplete="off">
      <input type="hidden" id="service-id">
      <div class="form-group">
        <label for="service-details-textarea">Service Details</label>
        <textarea id="service-details-textarea" rows="4" readonly></textarea>
      </div>
      <div class="form-group">
        <label>Enabled</label>
        <label class="toggle-switch">
          <input type="checkbox" id="enabled-toggle">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <button type="submit" class="button button-primary" id="modal-save-btn">Save</button>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded',() => {
  const state={currentMode:'Fully Managed',currentRole:'Admin',sblEnabled:false,dirty:false,services:[]};

  const qs=id=>document.getElementById(id);
  const serviceList=qs('service-list');
  const modeSelect=qs('mode-select');
  const roleSelect=qs('role-select');
  const modeBadge=qs('mode-badge');
  const roleBadge=qs('role-badge');
  const addServiceBtn=qs('add-service-btn');
  const enableAllToggle=qs('enable-all-toggle');
  const saveBtn=qs('save-changes-btn');
  const actionsBar=qs('actions-bar');
  const tableWrapper=qs('table-wrapper');
  const deployHeader=qs('deploy-col-header');
  const actionsHeader=qs('actions-col-header');
  const confirmMsg=qs('confirmation-msg');

  const modal=qs('service-modal');
  const modalInner=qs('modal-inner');
  const modalClose=document.querySelector('.modal-close');
  const serviceIdInput=qs('service-id');
  const serviceDetailsTextarea=qs('service-details-textarea');
  const enabledToggle=qs('enabled-toggle');
  const modalSaveBtn=qs('modal-save-btn');
  const readOnlyOverlay=document.querySelector('.read-only-overlay');

  let idSeq=0;
  const dayMs=86400000;
  const past=()=>new Date(Date.now()-Math.floor(Math.random()*30)*dayMs).toISOString();
  const make=(n,d,en,de)=>({id:++idSeq,name:n,description:d,lastUpdated:past(),enabled:en,deploy:de,lastRunDate:de?past():null});

  const catalog={
    'Fully Managed':[
      make('Identity Core','Central auth & SSO integration.',true,true),
      make('Policy Engine','Org policy evaluation layer.',true,true),
      make('Billing Reconciliation','Automated usage to invoice mapping.',true,false),
      make('Compliance Scanner','Baseline compliance checks.',true,true),
      make('Secrets Vault','Managed secret storage.',true,true),
      make('Geo Replicator','Cross-region replication service.',false,false)
    ],
    'Partially Managed':[
      make('Notification Service','Email & SMS dispatch.',false,false),
      make('Report Generator','Generates scheduled PDFs.',true,false),
      make('Cache Service','Low-latency data caching.',true,false),
      make('Image Optimizer','On-demand media transforms.',false,false),
      make('Search Indexer','Incremental indexing tasks.',true,true)
    ],
    'Restricted':[
      make('Access Registry','Registry of access grants.',true,true),
      make('Audit Log Stream','Immutable audit trail exporter.',true,true),
      make('Tag Normalizer','Enforces resource tagging.',false,false)
    ],
    'Unmanaged':[
      make('Custom Analytics','Experimental analytics stack.',true,false),
      make('Webhook Relay','3rd-party webhook fan-out.',false,false),
      make('Data Sandbox','Isolated data exploration.',true,false),
      make('Prototype ML','Model experimentation area.',false,false),
      make('Internal Dashboard','Legacy operational dashboard.',true,false)
    ]
  };

  const fmt=iso=>!iso?'':new Date(iso).toLocaleDateString()+" "+new Date(iso).toLocaleTimeString();
  const cloneMode=mode=>catalog[mode].map(s=>({...s}));
  const setDirty=()=>{state.dirty=true;updateSaveBtn();};

  function caps(){
    const readOnly=state.currentRole==='Read Only';
    const mode=state.currentMode;
    const restricted=mode==='Restricted';
    const fully=mode==='Fully Managed';
    const canToggleEnabled=!readOnly && !restricted && !fully;
    const showSave = !readOnly && (mode==='Partially Managed' || mode==='Unmanaged');
    return {
      readOnly,fully,restricted,
      hideDeploy:fully||restricted,
      hideActions:fully||restricted||readOnly,
      canToggleEnabled,
      canEdit:canToggleEnabled,
      canDelete:canToggleEnabled && mode!=='Partially Managed',
      showSave
    };
  }

  function renderList(){
    if(!state.sblEnabled){serviceList.innerHTML='';return;}
    serviceList.innerHTML=state.services.map(s=>`
      <tr data-id="${s.id}">
        <td>
          <div class="service-details">
            <span class="name">${s.name}</span>
            <span class="description">${s.description}</span>
            <span class="last-updated">Updated: ${fmt(s.lastUpdated)}</span>
          </div>
        </td>
        <td>
          <button class="status-button-like ${s.enabled?'enabled':'disabled'}" data-action="toggle" data-id="${s.id}">
            ${s.enabled?'Enabled':'Disabled'}
          </button>
        </td>
        <td class="deploy-cell">
          <div class="deploy-wrapper">
            <input type="checkbox" ${s.deploy?'checked':''} disabled>
            ${s.deploy && s.lastRunDate?`<div class="last-run">Last Run: ${fmt(s.lastRunDate)}</div>`:''}
          </div>
        </td>
        <td class="actions-cell">
          <div class="action-buttons">
            <button class="action-button edit" data-action="edit" data-id="${s.id}" title="Edit">üìù</button>
            <button class="action-button delete" data-action="delete" data-id="${s.id}" title="Delete">üóëÔ∏è</button>
          </div>
        </td>
      </tr>`).join('');
    applyCapabilities();
  }

  function applyCapabilities(){
    if(!state.sblEnabled) return;
    const c=caps();
    modeBadge.textContent=state.currentMode;
    modeBadge.className='mode-badge mode-'+state.currentMode.split(' ')[0];
    roleBadge.textContent=state.currentRole;
    roleBadge.className='role-badge role-'+(c.readOnly?'Read':'Admin');

    deployHeader.classList.toggle('hidden',c.hideDeploy);
    actionsHeader.classList.toggle('hidden',c.hideActions);
    document.querySelectorAll('.deploy-cell').forEach(td=>td.classList.toggle('hidden',c.hideDeploy));
    document.querySelectorAll('.actions-cell').forEach(td=>td.classList.toggle('hidden',c.hideActions));

    document.querySelectorAll('.status-button-like').forEach(btn=>{
      btn.disabled=!c.canToggleEnabled;
      btn.style.pointerEvents=btn.disabled?'none':'auto';
      btn.style.opacity=btn.disabled?'.55':'1';
      if(btn.disabled){
        btn.title=c.fully?'Disabled in Fully Managed mode':
                 c.restricted?'Disabled in Restricted mode':
                 c.readOnly?'Disabled for Read Only role':'';
      } else btn.removeAttribute('title');
    });

    document.querySelectorAll('.action-button.edit').forEach(b=>{
      b.disabled=!c.canEdit;
      b.style.opacity=b.disabled?'.35':'1';
      b.style.pointerEvents=b.disabled?'none':'auto';
    });
    document.querySelectorAll('.action-button.delete').forEach(b=>{
      b.disabled=!c.canDelete;
      b.style.opacity=b.disabled?'.35':'1';
      b.style.pointerEvents=b.disabled?'none':'auto';
    });

    syncMasterToggle();
    updateSaveBtn();
  }

  function syncMasterToggle(){
    if(!state.sblEnabled){
      enableAllToggle.checked=false;
      enableAllToggle.indeterminate=false;
      enableAllToggle.disabled=true;
      return;
    }
    const c=caps();
    const total=state.services.length;
    const enabled=state.services.filter(s=>s.enabled).length;
    enableAllToggle.indeterminate=enabled>0 && enabled<total;
    enableAllToggle.checked=total>0 && enabled===total;
    enableAllToggle.disabled=!c.canToggleEnabled || total===0;
  }

  // Updated logic: show only when SBL enabled AND role=Admin AND mode in (Partially Managed, Unmanaged)
  function updateSaveBtn(){
    const c=caps();
    const show = state.sblEnabled && c.showSave;
    saveBtn.style.display = show ? 'inline-block' : 'none';
    saveBtn.disabled = !show || !state.dirty;
  }

  function flash(msg){
    confirmMsg.textContent=msg;
    confirmMsg.classList.add('visible');
    setTimeout(()=>confirmMsg.classList.remove('visible'),1600);
  }

  function openModal(svc){
    const c=caps();
    serviceIdInput.value=svc.id;
    serviceDetailsTextarea.value=`Name: ${svc.name}
Description: ${svc.description}
Last Updated: ${fmt(svc.lastUpdated)}`;
    enabledToggle.checked=svc.enabled;
    const disabled=!c.canToggleEnabled;
    enabledToggle.disabled=disabled;
    if(disabled){
      modalInner.classList.add('read-only');
      readOnlyOverlay.style.display='block';
      modalSaveBtn.style.display='none';
    }else{
      modalInner.classList.remove('read-only');
      readOnlyOverlay.style.display='none';
      modalSaveBtn.style.display='inline-block';
    }
    modal.style.display='flex';
  }
  const closeModal=()=>modal.style.display='none';

  addServiceBtn.addEventListener('click',()=>{
    if(state.currentRole==='Read Only') return;
    state.sblEnabled=!state.sblEnabled;
    addServiceBtn.textContent=state.sblEnabled?'Disable SBL Service':'Enable SBL Service';
    if(state.sblEnabled){
      state.services=cloneMode(state.currentMode);
      state.dirty=false;
      tableWrapper.style.display='block';
      actionsBar.style.display='flex';
    }else{
      tableWrapper.style.display='none';
      actionsBar.style.display='none';
      state.services=[];
    }
    renderList();
    updateSaveBtn();
  });

  modeSelect.addEventListener('change',()=>{
    state.currentMode=modeSelect.value;
    if(state.sblEnabled){
      state.services=cloneMode(state.currentMode);
      state.dirty=false;
      renderList();
    }else{
      modeBadge.textContent=state.currentMode;
      modeBadge.className='mode-badge mode-'+state.currentMode.split(' ')[0];
    }
    updateSaveBtn();
  });

  roleSelect.addEventListener('change',()=>{
    state.currentRole=roleSelect.value;
    addServiceBtn.disabled=state.currentRole==='Read Only';
    if(state.sblEnabled) applyCapabilities();
    updateSaveBtn();
  });

  enableAllToggle.addEventListener('change',e=>{
    const c=caps();
    if(!c.canToggleEnabled) return syncMasterToggle();
    const target=e.target.checked;
    const now=new Date().toISOString();
    let changed=false;
    state.services.forEach(s=>{
      if(s.enabled!==target){
        s.enabled=target;
        s.lastUpdated=now;
        changed=true;
      }
    });
    if(changed){state.dirty=true;updateSaveBtn();}
    renderList();
  });

  serviceList.addEventListener('click',e=>{
    const btn=e.target.closest('[data-action]');
    if(!btn||!state.sblEnabled) return;
    const id=+btn.dataset.id;
    const svc=state.services.find(s=>s.id===id);
    if(!svc) return;
    const c=caps();
    switch(btn.dataset.action){
      case 'toggle':
        if(!c.canToggleEnabled) return;
        svc.enabled=!svc.enabled;
        svc.lastUpdated=new Date().toISOString();
        state.dirty=true;
        updateSaveBtn();
        renderList();
        break;
      case 'edit':
        if(!c.canEdit) return;
        openModal(svc);
        break;
      case 'delete':
        if(!c.canDelete) return;
        if(confirm('Delete this service?')){
          state.services=state.services.filter(s=>s.id!==id);
          state.dirty=true;
          updateSaveBtn();
          renderList();
        }
        break;
    }
  });

  modalClose.addEventListener('click',closeModal);
  window.addEventListener('click',e=>{if(e.target===modal) closeModal();});

  document.getElementById('service-form').addEventListener('submit',e=>{
    e.preventDefault();
    const id=+serviceIdInput.value;
    const svc=state.services.find(s=>s.id===id);
    if(svc){
      const newVal=!!enabledToggle.checked;
      if(svc.enabled!==newVal){
        svc.enabled=newVal;
        svc.lastUpdated=new Date().toISOString();
        state.dirty=true;
        updateSaveBtn();
      }
    }
    closeModal();
    renderList();
  });

  saveBtn.addEventListener('click',e=>{
    e.preventDefault();
    if(saveBtn.disabled) return;
    state.dirty=false;
    updateSaveBtn();
    flash('Changes saved (demo).');
  });

  addServiceBtn.disabled=false;
});
</script>
</body>
</html>